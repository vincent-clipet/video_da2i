
function Anim(s,t,i){this.start=s,this.end=t,this.speed=i,this.val=0,this.update=function(){this.isInProgress()&&(this.val+=this.speed*speed)},this.isInProgress=function(){return frame>=this.start&&frame<this.end}}
function Background(i,t){this.x=0,this.y=0,this.image=imagesList[i],this.textSigns=t,this.move=function(i,t){this.x+=i,this.y+=t;for(sign in this.textSigns)this.textSigns[sign].move(i,t)},this.draw=function(){ctx.drawImage(this.image,scrollX+this.x,scrollY+this.y);for(key in this.textSigns){var i=this.textSigns[key];i.draw()}}}
function FadeIn(t,i){this.start=t,this.timeFadeIn=i,this.end=t+i,this.val=1,this.interval=1/i,this.update=function(){frame==this.end-1?this.val=0:this.isInProgress()&&(this.val-=this.interval)},this.draw=function(){this.isInProgress()&&(ctx.fillStyle="rgba(0,0,0,"+this.val+")",ctx.fillRect(0,0,1280,640))},this.isInProgress=function(){return frame>=this.start&&frame<this.end},this.hasEnded=function(){return frame>this.end}}
function FadeOut(t,i,s){this.start=t,this.timeFadeOut=i,this.timeStopped=s,this.end=this.start+this.timeFadeOut+this.timeStopped,this.val=0,this.interval=1/i,this.frameNextFunction=this.end-1,this.update=function(){this.isInProgress()&&(frame<this.start+this.timeFadeOut?this.val+=this.interval:frame<this.end&&(this.val=1))},this.draw=function(){this.isInProgress()&&(ctx.fillStyle="rgba(0,0,0,"+this.val+")",ctx.fillRect(0,0,1280,640))},this.mustChangePart=function(){return frame>=this.frameNextFunction},this.isInProgress=function(){return frame>=this.start&&frame<this.end}}
function SchoolTree(s,i,t,h,e){this.x=s,this.y=i,this.sy=t,this.image=imagesList[h],this.anims=e,this.scroll=function(s){this.sy-=s},this.move=function(s,i){this.x+=s,this.y+=i},this.update=function(){for(var s=0;s<e.length;s++){var i=this.anims[s];i.update(),i.isInProgress()&&this.scroll(i.speed*speed)}},this.draw=function(){ctx.drawImage(this.image,0,1290+this.sy,400,640,this.x,this.y,400,640)}}
function Slide(t,s,e){this.start=t,this.end=t+s,this.endOffset=e,this.totalDuration=s,this.accelFrames=.25*this.totalDuration,this.endAcceleration=this.start+this.accelFrames,this.startDeceleration=this.end-this.accelFrames,this.maxSpeed=this.endOffset*(2/3)/(this.totalDuration/2),this.val=0,this.speed=0,this.factor=this.maxSpeed/this.accelFrames,this.update=function(){this.isInProgress()&&(this.speed>this.maxSpeed&&(this.speed=this.maxSpeed),frame>=this.end-1&&(this.speed=0,this.factor=0,this.val=this.endOffset),frame<this.endAcceleration?(this.speed+=this.factor,this.val+=this.speed):frame>=this.endAcceleration&&frame<this.startDeceleration?this.val+=this.speed:frame>=this.startDeceleration&&(this.speed-=this.factor,this.val+=this.speed))},this.isInProgress=function(){return frame>=this.start&&frame<this.end}}
function Sprite(r,t,i,h,o){this.x=r,this.y=t,this.image=imagesList[i],this.cropCoord=h,this.currSprite=o,this.move=function(r,t){this.x+=r,this.y+=t},this.update=function(){Math.floor(frame)%4==0&&(this.currSprite++,this.currSprite>=this.cropCoord.length&&(this.currSprite=0))},this.draw=function(){ctx.drawImage(this.image,this.cropCoord[this.currSprite][0],this.cropCoord[this.currSprite][1],this.cropCoord[this.currSprite][2],this.cropCoord[this.currSprite][3],this.x,this.y,this.cropCoord[this.currSprite][2],this.cropCoord[this.currSprite][3])}}
function TextSign(i,t,h,s,e,g,a,n){this.x=i,this.y=t,this.sx=h,this.sy=s,this.width=e-h,this.height=g-s,this.factor=a,this.image=imagesList[n],this.move=function(i,t){this.x+=2*i*a,this.y+=t},this.draw=function(){ctx.drawImage(this.image,this.sx,this.sy,this.width,this.height,this.x,this.y,this.width,this.height)}}
function Part1(){this.boy=new Sprite(70,534,"images/spritesBoy.png",[[0,0,43,88],[43,0,43,87],[86,0,43,88],[129,0,43,87]],0),this.girl=new Sprite(120,540,"images/spritesGirl.png",[[0,0,39,81],[39,0,40,81],[79,0,39,81],[118,0,38,81]],1),this.bg1=new Background("images/background.png",[new TextSign(800,30,5,5,412,97,2,"images/signs.png"),new TextSign(1500,230,2,104,413,203,1.95,"images/signs.png"),new TextSign(2200,70,4,205,464,333,1.9,"images/signs.png"),new TextSign(2900,150,2,335,484,465,1.85,"images/signs.png"),new TextSign(3650,50,4,467,474,535,1.8,"images/signs.png")]),this.anims=[new Anim(60,160,2),new Anim(450,560,1.2),new Anim(1150,1240,1.2),new Anim(1650,1800,1.4)],this.tree=new SchoolTree(880,0,0,"images/tree.png",this.anims),this.fadeIn=new FadeIn(1,20),this.fadeOut=new FadeOut(2200,30,20),this.init=function(){scrollX=0,scrollY=0},this.update=function(){scrollX-=speed/2,this.bg1.move(-speed/2,0),this.boy.move(.3*speed,0),this.girl.move(.3*speed,0),this.boy.update(),this.girl.update(),this.tree.update(),this.fadeIn.update(),this.fadeOut.update(),this.fadeOut.mustChangePart()&&nextPart(new Part2)},this.draw=function(){this.bg1.draw(),this.tree.draw(),this.boy.draw(),this.girl.draw(),this.fadeIn.draw(),this.fadeOut.draw()}}
function Part2(){this.bg2=new Background("images/background2.png"),this.fadeIn=new FadeIn(2248,20),this.fadeOut=new FadeOut(3320,30,20),this.slides=[new Slide(2450,20,800),new Slide(2620,20,800),new Slide(2790,20,800),new Slide(2960,20,800),new Slide(3130,20,800),new Slide(3310,60,2400)],this.init=function(){scrollX=0,scrollY=0,speed=1},this.update=function(){for(key in this.slides)this.slides[key].update(),this.slides[key].isInProgress()&&(scrollX-=this.slides[key].speed);this.fadeOut.update(),this.fadeIn.update(),this.fadeOut.mustChangePart()&&nextPart(new Part3)},this.draw=function(){this.bg2.draw(),this.fadeIn.draw(),this.fadeOut.draw()}}
function Part3(){this.boy=part1.boy,this.boy.x=100,this.girl=part1.girl,this.girl.x=150,this.bg3=new Background("images/background3.png",[new TextSign(800,20,5,542,451,641,2,"images/signs.png"),new TextSign(1480,170,3,646,539,710,2,"images/signs.png"),new TextSign(2160,80,3,718,507,815,2,"images/signs.png"),new TextSign(2840,175,6,822,457,888,2,"images/signs.png"),new TextSign(3480,100,6,892,445,992,2,"images/signs.png"),new TextSign(4050,210,7,994,388,1036,2,"images/signs.png")]),this.fadeIn=new FadeIn(3367,20),this.fadeOut=new FadeOut(5e3,30,20),this.init=function(){scrollX=0,scrollY=0,speed=initSpeed},this.update=function(){scrollX-=speed/2*1.05,this.bg3.move(-speed/2*1.05,0),this.boy.move(.58*speed,0),this.girl.move(.58*speed,0),this.boy.update(),this.girl.update(),this.fadeIn.update(),this.fadeOut.update(),this.fadeOut.mustChangePart()&&nextPart(new Part4)},this.draw=function(){this.bg3.draw(),this.boy.draw(),this.girl.draw(),this.fadeIn.draw(),this.fadeOut.draw()}}
function Part4(){this.bg4=new Background("images/background4.png"),this.fadeIn=new FadeIn(5047,20),this.init=function(){scrollX=0,scrollY=0},this.update=function(){this.fadeIn.update(),this.fadeIn.hasEnded()&&(pause=!0)},this.draw=function(){this.bg4.draw(),this.fadeIn.draw()}}
var canvas=document.getElementById("da2i");canvas.focus();var ctx=canvas.getContext("2d"),pause=!0,frame=0,initSpeed=2.5,speed=initSpeed,realFrame=0,frameInterval=50,interval=null,currentPart=null,part1=null,scrollX=null,scrollY=null,fullspeedFrame=null,fullspeed=!1,imagesUrl=["images/background.png","images/background2.png","images/background3.png","images/background4.png","images/spritesBoy.png","images/spritesGirl.png","images/tree.png","images/signs.png"],count=imagesUrl.length,imagesList=new Array;for(img in imagesUrl){var url=imagesUrl[img];imagesList[url]=new Image,imagesList[url].src=url,imagesList[url].onload=function(){count--,0==count&&(currentPart=new Part1,part1=currentPart,currentPart.init(),null==fullspeedFrame?interval=setInterval(update,frameInterval):(interval=setInterval(update,1),fullspeed=!0),pause=!1)}}canvas.addEventListener("keydown",function(e){32===e.keyCode&&(pause=!pause),draw()},!1);var nextPart=function(e){currentPart=e,currentPart.init(),currentPart.update()},update=function(){pause||(realFrame++,frame+=speed,Math.floor(frame)%20==0&&(console.log("realFrame = "+realFrame),console.log("frame = "+Math.floor(frame))),frame>=fullspeedFrame&&fullspeed&&(clearInterval(interval),interval=setInterval(update,frameInterval),fullspeed=!1),currentPart.update(),draw())},draw=function(){ctx.clearRect(0,0,canvas.width,canvas.height),ctx.save(),currentPart.draw(),ctx.restore()};